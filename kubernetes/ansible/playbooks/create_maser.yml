---
- hosts: master
  gather_facts: no
  become: true
  name: Create master cluster
  tasks:
    - name: Initialize kubeadm
      ansible.builtin.command: kubeadm init --pod-network-cidr=10.244.0.0/16
    - name: Create kubectl config dir
      ansible.builtin.file:
        path: /home/ubuntu/.kube
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: 0755
    - name: Config ubuntu user
      ansible.builtin.copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ubuntu/.kube/config
        remote_src: true
        owner: ubuntu
        group: ubuntu
        mode: 0600
    - name: Install calico
      become: false
      ansible.builtin.command: "{{ item }}"
      with_items:
        - kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/tigera-operator.yaml
        - curl https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/custom-resources.yaml -O
        - sed -i -e "s?192.168.0.0/16?10.244.0.0/16?g" custom-resources.yaml
        - kubectl apply -f custom-resources.yaml
      args:
        chdir: $HOME
